<!doctype html>
<html lang="en">
  <head>
    <script src="static/bootstrap.js?v=__CAR_ASSET_VERSION__" data-car-bootstrap></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#0a0c12" />
    <title>Codex Autorunner</title>
  </head>
  <body>
    <div id="hub-shell" class="hub-shell hidden">
      <header class="hub-hero">
        <div class="hub-hero-text">
          <h1>CAR Hub</h1>
          <span id="hub-last-scan" class="pill pill-small pill-idle">‚Äì</span>
          <span id="hub-version" class="hub-version">v‚Äì</span>
        </div>
        <div class="hub-hero-actions">
          <button id="hub-new-repo" class="primary sm">+ New</button>
          <button id="hub-scan" class="sm">Scan</button>
          <button id="hub-refresh" class="ghost sm">Refresh</button>
          <button id="hub-settings" class="ghost sm icon-btn" title="Settings">‚öô</button>
        </div>
      </header>

      <section class="hub-stats">
        <div class="hub-stat">
          <div id="hub-count-total" class="hub-stat-value">‚Äì</div>
          <p class="muted small">repos</p>
        </div>
        <div class="hub-stat">
          <div id="hub-count-running" class="hub-stat-value">‚Äì</div>
          <p class="muted small">running</p>
        </div>
        <div class="hub-stat">
          <div id="hub-count-missing" class="hub-stat-value">‚Äì</div>
          <p class="muted small">missing</p>
        </div>
      </section>

      <section class="hub-usage-compact">
        <div class="hub-usage-header">
          <span class="label">Usage</span>
          <span id="hub-usage-meta" class="hub-usage-path">‚Äì</span>
          <button id="hub-usage-refresh" class="ghost sm icon-btn" title="Refresh usage">‚Üª</button>
        </div>
        <div id="hub-usage-list" class="hub-usage-grid">Loading‚Ä¶</div>
      </section>

      <section class="hub-usage-chart">
        <div class="hub-usage-chart-header">
          <span class="label">Usage Trend</span>
          <div class="usage-chart-controls">
            <select id="hub-usage-chart-range" class="usage-chart-select" title="Range" aria-label="Range">
              <option value="7">1w</option>
              <option value="30" selected>1m</option>
              <option value="90">3m</option>
              <option value="180">6m</option>
              <option value="365">1y</option>
            </select>
            <select id="hub-usage-chart-segment" class="usage-chart-select" title="Group" aria-label="Group">
              <option value="none">Total</option>
              <option value="repo">By repo</option>
              <option value="agent">By agent</option>
            </select>
          </div>
        </div>
        <div id="hub-usage-chart-canvas" class="usage-chart-canvas hub-usage-chart-canvas"></div>
      </section>

      <section class="hub-repo-panel">
        <div class="hub-panel-header">
          <span class="label">Repositories</span>
          <div class="hub-panel-actions">
            <button id="hub-quick-scan" class="ghost sm">Rescan</button>
          </div>
        </div>
        <div id="hub-repo-list" class="hub-repo-list">
          <div class="muted small">Loading‚Ä¶</div>
        </div>
      </section>
    </div>

    <div id="repo-shell" class="app-shell">
      <nav class="nav-bar">
        <span class="nav-brand">CAR</span>
        <div class="tabs">
          <!-- Tabs will be injected here by tabs.js -->
        </div>
        <div class="nav-actions">
          <button id="repo-settings" class="ghost sm icon-btn" title="Settings">‚öô</button>
        </div>
      </nav>

      <main>
        <section id="dashboard" class="panel active">
          <div class="cards">
            <div class="card status-card">
              <div class="card-header">
                <div class="card-header-left">
                  <span class="label">Runner Status</span>
                  <span id="repo-version" class="version-label">v‚Äì</span>
                </div>
                <span id="runner-status" class="pill pill-idle">idle</span>
              </div>
              <div class="grid-two">
                <div>
                  <p class="muted">Run ID</p>
                  <p id="last-run-id" class="metric">‚Äì</p>
                </div>
                <div>
                  <p class="muted">Exit</p>
                  <p id="last-exit-code" class="metric">‚Äì</p>
                </div>
                <div>
                  <p class="muted">Started</p>
                  <p id="last-start" class="metric">‚Äì</p>
                </div>
                <div>
                  <p class="muted">Finished</p>
                  <p id="last-finish" class="metric">‚Äì</p>
                </div>
                <div>
                  <p class="muted">TODO</p>
                  <p id="todo-count" class="metric">‚Äì</p>
                </div>
                <div>
                  <p class="muted">Done</p>
                  <p id="done-count" class="metric">‚Äì</p>
                </div>
              </div>
              <div class="doc-agent-controls dashboard-agent-controls">
                <select id="dashboard-agent-select" title="Agent"></select>
                <select id="dashboard-model-select" title="Model"></select>
                <select id="dashboard-reasoning-select" title="Reasoning"></select>
              </div>
              <div class="actions">
                <button id="start-run" class="primary" title="Run a full autorunner iteration through all tasks">Start</button>
                <button id="stop-run" class="ghost" title="Gracefully stop the current run (safe shutdown)">Stop</button>
                <button id="kill-run" class="danger" title="Immediately terminate the run (force stop - may cause data loss)">Kill</button>
                <button id="clear-lock" class="ghost hidden" title="Clear a stale autorunner lock">Clear lock</button>
                <button id="reset-runner" class="ghost" title="Clear run state and restart fresh (destructive)">Reset</button>
                <button id="refresh-state" class="ghost icon-btn" title="Refresh state">‚Üª</button>
              </div>
              <p class="muted small" id="runner-pid">PID: ‚Äì</p>
            </div>

            <div class="card usage-card-compact">
              <div class="usage-header">
                <span class="label">Usage</span>
                <span class="usage-total-badge" id="usage-total">‚Äì</span>
                <span class="usage-events-badge" id="usage-events">‚Äì</span>
                <button id="usage-refresh" class="ghost sm icon-btn" title="Refresh usage">‚Üª</button>
              </div>
              <div class="usage-breakdown">
                <div class="usage-stat">
                  <span class="usage-stat-val" id="usage-input">‚Äì</span>
                  <span class="usage-stat-lbl">in</span>
                </div>
                <div class="usage-stat usage-stat-cached">
                  <span class="usage-stat-val" id="usage-cached">‚Äì</span>
                  <span class="usage-stat-lbl">cached</span>
                </div>
                <div class="usage-stat">
                  <span class="usage-stat-val" id="usage-output">‚Äì</span>
                  <span class="usage-stat-lbl">out</span>
                </div>
                <div class="usage-stat">
                  <span class="usage-stat-val" id="usage-reasoning">‚Äì</span>
                  <span class="usage-stat-lbl">reason</span>
                </div>
              </div>
              <div class="usage-chart">
                <div class="usage-chart-header">
                  <span class="usage-chart-title">Trend</span>
                  <div class="usage-chart-controls">
                    <select id="usage-chart-range" class="usage-chart-select" title="Range" aria-label="Range">
                      <option value="7">1w</option>
                      <option value="30" selected>1m</option>
                      <option value="90">3m</option>
                      <option value="180">6m</option>
                      <option value="365">1y</option>
                    </select>
                    <select id="usage-chart-segment" class="usage-chart-select" title="Group" aria-label="Group">
                      <option value="none">Total</option>
                      <option value="agent">Agent</option>
                      <option value="model">Model</option>
                      <option value="token_type">Token type</option>
                      <option value="model_token">Model + type</option>
                    </select>
                  </div>
                </div>
                <div id="usage-chart-canvas" class="usage-chart-canvas"></div>
              </div>
              <div class="usage-rates-visual">
                <div class="usage-rate-row">
                  <span class="usage-rate-label">Primary</span>
                  <div id="usage-rate-primary" class="usage-rate-bar-container"></div>
                </div>
                <div class="usage-rate-row">
                  <span class="usage-rate-label">Secondary</span>
                  <div id="usage-rate-secondary" class="usage-rate-bar-container"></div>
                </div>
              </div>
              <div class="usage-footer">
                <span id="usage-rates" class="hidden">‚Äì</span>
                <span id="usage-meta">‚Äì</span>
              </div>
            </div>

            <div class="card todo-preview">
              <div class="card-header">
                <span class="label">TODO</span>
                <button id="open-summary" class="primary sm hidden" title="Open final report (SUMMARY)">Summary</button>
                <button id="refresh-preview" class="ghost sm icon-btn" title="Refresh TODO preview">‚Üª</button>
              </div>
              <ul id="todo-preview-list" class="checklist"></ul>
            </div>

            <div class="card github-card" id="github-card">
              <div class="card-header">
                <span class="label">GitHub</span>
                <span id="github-status-pill" class="pill pill-idle">‚Äì</span>
              </div>
              <div class="github-grid">
                <div class="github-row">
                  <span class="muted">Repo</span>
                  <a id="github-repo-link" class="github-link muted">‚Äì</a>
                </div>
                <div class="github-row">
                  <span class="muted">Branch</span>
                  <span id="github-branch" class="github-mono">‚Äì</span>
                </div>
                <div class="github-row">
                  <span class="muted">Issue</span>
                  <a id="github-issue-link" class="github-link muted">‚Äì</a>
                </div>
                <div class="github-row">
                  <span class="muted">PR</span>
                  <span class="github-pr-group">
                    <a id="github-pr-link" class="github-link muted">‚Äì</a>
                    <button id="github-open-pr-files" class="ghost icon-btn-inline" disabled title="View changed files">üìÑ</button>
                    <button id="github-copy-pr" class="ghost icon-btn-inline" disabled title="Copy PR link">üìã</button>
                  </span>
                </div>
              </div>
              <div class="actions github-actions">
                <button id="github-sync-pr" class="primary sm">Sync PR</button>
              </div>
              <div class="github-flow">
                <div class="github-flow-header">
                  <span class="muted">PR Flow</span>
                  <span id="pr-flow-status" class="pill pill-idle">‚Äì</span>
                </div>
                <div class="github-flow-grid">
                  <label class="muted" for="pr-flow-mode">Mode</label>
                  <select id="pr-flow-mode">
                    <option value="issue">Implement Issue ‚Üí PR</option>
                    <option value="pr">Fix Existing PR</option>
                  </select>
                  <label class="muted" for="pr-flow-ref">Issue / PR</label>
                  <input
                    id="pr-flow-ref"
                    type="text"
                    spellcheck="false"
                    autocomplete="off"
                    placeholder="#123 or https://github.com/org/repo/issues/123"
                  />
                  <label class="muted" for="pr-flow-base">Base</label>
                  <input
                    id="pr-flow-base"
                    type="text"
                    spellcheck="false"
                    autocomplete="off"
                    placeholder="default"
                  />
                  <label class="muted" for="pr-flow-until">Until</label>
                  <select id="pr-flow-until">
                    <option value="no_issues">No issues</option>
                    <option value="minor_only">Minor only</option>
                  </select>
                  <label class="muted" for="pr-flow-cycles">Max cycles</label>
                  <input id="pr-flow-cycles" type="number" min="1" placeholder="3" />
                  <label class="muted" for="pr-flow-runs">Impl runs</label>
                  <input id="pr-flow-runs" type="number" min="1" placeholder="auto" />
                  <label class="muted" for="pr-flow-timeout">Timeout (s)</label>
                  <input id="pr-flow-timeout" type="number" min="0" placeholder="auto" />
                  <label class="muted" for="pr-flow-draft">Draft</label>
                  <input id="pr-flow-draft" type="checkbox" checked />
                </div>
                <div class="actions github-flow-actions">
                  <button id="pr-flow-start" class="primary sm">Start</button>
                  <button id="pr-flow-stop" class="ghost sm">Stop</button>
                  <button id="pr-flow-resume" class="ghost sm">Resume</button>
                  <button id="pr-flow-collect" class="ghost sm">Collect reviews</button>
                </div>
                <div class="github-flow-status">
                  <div class="github-flow-row">
                    <span class="muted">Step</span>
                    <span id="pr-flow-step" class="github-mono">‚Äì</span>
                  </div>
                  <div class="github-flow-row">
                    <span class="muted">Cycle</span>
                    <span id="pr-flow-cycle" class="github-mono">‚Äì</span>
                  </div>
                  <div class="github-flow-row">
                    <span class="muted">Review</span>
                    <span id="pr-flow-review" class="github-mono">‚Äì</span>
                  </div>
                </div>
                <div class="github-flow-artifacts">
                  <a id="pr-flow-review-link" class="github-link muted">Review bundle</a>
                  <a id="pr-flow-log-link" class="github-link muted">Workflow log</a>
                  <a id="pr-flow-final-link" class="github-link muted">Final report</a>
                </div>
               </div>
               <p id="github-note" class="muted small">‚Äì</p>
             </div>
           </div>

           <div class="card review-card" id="review-card">
             <div class="card-header">
               <span class="label">Review</span>
               <span id="review-status-pill" class="pill pill-idle">‚Äì</span>
             </div>
             <div class="review-grid">
               <div class="review-row">
                 <span class="muted">Run ID</span>
                 <span id="review-run-id" class="review-mono">‚Äì</span>
               </div>
               <div class="review-row">
                 <span class="muted">Started</span>
                 <span id="review-started" class="review-mono">‚Äì</span>
               </div>
               <div class="review-row">
                 <span class="muted">Finished</span>
                 <span id="review-finished" class="review-mono">‚Äì</span>
               </div>
             </div>
             <div class="review-controls">
               <div class="review-inputs">
                 <div class="review-input-row">
                   <label class="muted" for="review-agent">Agent</label>
                   <input id="review-agent" type="text" value="opencode" spellcheck="false" />
                 </div>
                 <div class="review-input-row">
                   <label class="muted" for="review-model">Model</label>
                   <input id="review-model" type="text" value="zai-coding-plan/glm-4.7" spellcheck="false" />
                 </div>
                 <div class="review-input-row">
                   <label class="muted" for="review-reasoning">Reasoning</label>
                   <input id="review-reasoning" type="text" placeholder="auto" spellcheck="false" />
                 </div>
                 <div class="review-input-row">
                   <label class="muted" for="review-timeout">Timeout (s)</label>
                   <input id="review-timeout" type="number" min="60" placeholder="auto" spellcheck="false" />
                 </div>
               </div>
               <div class="review-buttons">
                 <button id="review-start" class="primary sm">Start</button>
                 <button id="review-stop" class="ghost sm">Stop</button>
                 <button id="review-reset" class="ghost sm">Reset</button>
               </div>
             </div>
             <div class="review-artifacts">
               <a id="review-final-link" class="review-link muted">Final report</a>
               <a id="review-log-link" class="review-link muted">Log</a>
               <a id="review-scratchpad-link" class="review-link muted">Scratchpad</a>
             </div>
           </div>
         </section>

         <section id="docs" class="panel">
          <div class="doc-nav">
            <button class="chip active" data-doc="todo">TODO</button>
            <button class="chip" data-doc="progress">PROGRESS</button>
            <button class="chip" data-doc="opinions">OPINIONS</button>
            <button class="chip" data-doc="spec">SPEC</button>
            <button class="chip" data-doc="summary">SUMMARY</button>
            <button class="chip" data-doc="snapshot">SNAPSHOT</button>
            <span class="muted" id="doc-status"></span>
          </div>
          <div id="doc-thread-registry-banner" class="doc-banner hidden">
            <div class="doc-banner-text">
              <div class="doc-banner-title">
                Conversation state reset due to corrupted registry.
              </div>
              <div id="doc-thread-registry-detail" class="doc-banner-detail muted small"></div>
            </div>
            <div class="doc-banner-actions">
              <button id="doc-thread-registry-reset" class="ghost sm">Reset conversations</button>
              <button id="doc-thread-registry-download" class="ghost sm">Download backup</button>
            </div>
          </div>
          <div id="spec-issue-import" class="spec-issue-import hidden">
            <button id="spec-issue-import-toggle" class="ghost sm">Import Issue ‚Üí SPEC</button>
            <div id="spec-issue-input-row" class="spec-issue-input-row hidden">
              <input
                id="spec-issue-input"
                type="text"
                spellcheck="false"
                autocomplete="off"
                placeholder="Issue number or URL (e.g. 123 or https://github.com/org/repo/issues/123)"
              />
              <button id="spec-issue-import-btn" class="primary sm">Import</button>
            </div>
          </div>
          <div class="doc-editor">
            <div id="spec-ingest-patch-main" class="doc-patch-main hidden">
              <div class="doc-patch-header">
                <div class="doc-patch-info">
                  <div class="muted small">Spec ingest patch</div>
                  <div id="spec-ingest-patch-summary" class="doc-patch-summary"></div>
                  <div class="doc-patch-legend">
                    <span class="doc-patch-legend-item doc-patch-legend-add">Added</span>
                    <span class="doc-patch-legend-item doc-patch-legend-del">Removed</span>
                  </div>
                </div>
                <div class="doc-patch-actions">
                  <button id="spec-ingest-patch-apply" class="primary sm">Apply Patch</button>
                  <button id="spec-ingest-patch-reload" class="ghost sm">Reload</button>
                  <button id="spec-ingest-patch-discard" class="danger sm">Discard</button>
                </div>
              </div>
              <div id="spec-ingest-patch-body" class="doc-patch-body">(no patch)</div>
            </div>
            <div id="doc-patch-main" class="doc-patch-main hidden">
              <div class="doc-patch-header">
                <div class="doc-patch-info">
                  <div class="muted small">Pending draft</div>
                  <div id="doc-patch-summary" class="doc-patch-summary"></div>
                  <div id="doc-patch-meta" class="doc-patch-meta"></div>
                  <div class="doc-patch-legend">
                    <span class="doc-patch-legend-item doc-patch-legend-add">Added</span>
                    <span class="doc-patch-legend-item doc-patch-legend-del">Removed</span>
                  </div>
                </div>
                <div class="doc-patch-actions">
                  <button id="doc-patch-apply" class="primary sm">Apply Draft</button>
                  <button id="doc-patch-preview" class="ghost sm" aria-pressed="false">Preview draft</button>
                  <button id="doc-patch-reload" class="ghost sm">Reload</button>
                  <button id="doc-patch-discard" class="danger sm">Discard</button>
                </div>
              </div>
              <div id="doc-patch-body" class="doc-patch-body">(no draft)</div>
            </div>
            <textarea id="doc-content" spellcheck="false"></textarea>
            <div class="doc-actions" id="doc-actions-standard">
              <button id="save-doc" class="primary" data-short="Save">Save</button>
              <button id="reload-doc" class="ghost" data-short="Reload">Reload</button>
              <button id="doc-copy" class="ghost hidden" data-short="Copy">Copy</button>
              <button id="spec-paste" class="ghost hidden" data-short="Paste">Paste</button>
              <button id="ingest-spec" class="ghost hidden" data-short="Ingest">Ingest SPEC ‚Üí Docs</button>
              <button id="clear-docs" class="danger hidden" data-short="Clear">Clear TODO/PROGRESS/OPINIONS</button>
            </div>
            <div class="doc-actions hidden" id="doc-actions-snapshot">
              <button id="snapshot-generate" class="primary" data-short="Run">Run snapshot</button>
              <button id="snapshot-copy" class="ghost" data-short="Copy">Copy</button>
              <button id="snapshot-refresh" class="ghost" data-short="Reload">Reload</button>
            </div>
            <div class="doc-chat-panel compose-panel">
              <div class="doc-chat-compose">
                <div class="doc-agent-controls">
                  <select id="doc-agent-select" title="Agent"></select>
                  <select id="doc-model-select" title="Model"></select>
                  <select id="doc-reasoning-select" title="Reasoning"></select>
                </div>
                <div class="doc-chat-input-row compose-row">
                  <textarea
                    id="doc-chat-input"
                    rows="1"
                    placeholder="Chat about the work docs..."
                    spellcheck="false"
                    enterkeyhint="enter"
                  ></textarea>
                  <div class="doc-chat-input-buttons compose-buttons">
                    <button id="doc-chat-voice" class="ghost sm voice-button" title="Hold to talk"></button>
                    <button id="doc-chat-send" class="primary sm" title="Send">‚Üë</button>
                  </div>
                </div>
                <div class="doc-chat-meta">
                  <div class="doc-chat-meta-left">
                    <span class="muted small" id="doc-chat-hint">Cmd+Enter/Ctrl+Enter to send ¬∑ Enter for newline</span>
                    <span class="muted small hidden voice-status" id="doc-chat-voice-status"></span>
                  </div>
                  <div class="doc-chat-meta-right">
                    <button id="doc-chat-cancel" class="ghost sm hidden doc-chat-cancel-inline" title="Cancel">‚úï</button>
                    <button id="doc-chat-new-thread" class="ghost sm" title="Start a new chat thread">New thread</button>
                    <span id="doc-chat-status" class="pill pill-idle">idle</span>
                  </div>
                </div>
              </div>
              <div class="doc-chat-stream" id="doc-chat-stream">
                <div id="doc-chat-error" class="doc-chat-error hidden"></div>
                <div id="doc-chat-events" class="doc-chat-events hidden">
                  <div class="doc-chat-section-header">
                    <div class="doc-chat-section-title">
                      Agent updates
                      <span id="doc-chat-events-count" class="doc-chat-count">0</span>
                    </div>
                    <button id="doc-chat-events-toggle" class="ghost sm hidden">
                      Show more
                    </button>
                  </div>
                  <div id="doc-chat-events-list" class="doc-chat-events-list"></div>
                </div>
                <div class="doc-chat-section-header">
                  <div class="doc-chat-section-title">
                    History
                    <span id="doc-chat-history-count" class="doc-chat-count">0</span>
                  </div>
                </div>
                <div id="doc-chat-history" class="doc-chat-history"></div>
              </div>
            </div>
          </div>
        </section>

        <section id="logs" class="panel">
          <div class="inline-toolbar">
            <label class="chip" data-short="Sum">
              <input id="log-show-summary" type="checkbox" checked />
              <span>Summary</span>
            </label>
            <label>Run <input id="log-run-id" type="number" min="1" placeholder="latest" /></label>
            <label>Tail <input id="log-tail" type="number" min="10" value="200" /></label>
            <button id="load-logs" class="primary sm">Load</button>
            <button id="toggle-log-stream" class="ghost sm">Stream</button>
            <label class="chip" data-short="TS">
              <input id="log-show-timestamp" type="checkbox" checked />
              <span>Timestamp</span>
            </label>
            <label class="chip" data-short="Run">
              <input id="log-show-run" type="checkbox" />
              <span>Run</span>
            </label>
          </div>
          <div class="log-legend">
            <span class="log-legend-item"><span class="log-legend-dot thinking"></span>Thinking</span>
            <span class="log-legend-item"><span class="log-legend-dot exec"></span>Tool calls</span>
            <span class="log-legend-item"><span class="log-legend-dot file"></span>File updates</span>
            <span class="log-legend-item"><span class="log-legend-dot diff-add"></span>Added</span>
            <span class="log-legend-item"><span class="log-legend-dot diff-del"></span>Removed</span>
            <span class="log-legend-item"><span class="log-legend-dot output"></span>Agent output</span>
            <span class="log-legend-item"><span class="log-legend-dot context"></span>Context</span>
          </div>
          <div class="log-container">
            <button id="log-load-older" class="log-load-btn hidden" title="Load older logs">Load older</button>
            <pre id="log-output" class="log-viewer">(no log loaded)</pre>
            <button id="log-jump-bottom" class="log-jump-btn hidden" title="Jump to latest">‚Üì Latest</button>
          </div>
        </section>

        <section id="runs" class="panel">
          <div class="inline-toolbar runs-toolbar">
            <button id="runs-refresh" class="primary sm">Refresh</button>
            <label>
              Attribution
              <select id="runs-attribution-mode">
                <option value="split">Split (default)</option>
                <option value="full">Full (upper bound)</option>
              </select>
            </label>
            <label>
              TODO filter
              <input id="runs-todo-search" type="text" placeholder="Search TODOs" />
            </label>
          </div>
          <div class="runs-layout">
            <div class="runs-card">
              <div class="runs-card-header">
                <span class="label">Runs</span>
              </div>
              <table class="runs-table">
                <thead>
                  <tr>
                    <th>Run</th>
                    <th>Status</th>
                    <th>Started</th>
                    <th>Model</th>
                    <th>Tokens</th>
                    <th>Completed TODOs</th>
                  </tr>
                </thead>
                <tbody id="runs-table-body"></tbody>
              </table>
            </div>
            <div class="runs-card">
              <div class="runs-card-header runs-card-header-inline">
                <span class="label">Tokens per TODO</span>
                <span id="runs-todo-summary" class="muted small">‚Äì</span>
              </div>
              <div id="runs-todo-list" class="runs-todo-list">No TODOs yet.</div>
            </div>
          </div>
        </section>

        <section id="terminal" class="panel">
          <div class="terminal-toolbar">
            <div class="terminal-toolbar-row terminal-toolbar-main">
              <span id="terminal-status" class="terminal-status muted">Disconnected</span>
              <div class="terminal-actions">
                <button id="terminal-connect" class="primary sm">New</button>
                <button id="terminal-resume" class="ghost sm">Resume</button>
                <button id="terminal-disconnect" class="ghost sm">Disconnect</button>
              </div>
            </div>
            <div class="terminal-toolbar-row terminal-toolbar-config">
              <div class="terminal-agent-controls">
                <select id="terminal-agent-select" title="Agent"></select>
                <select id="terminal-model-select" title="Model"></select>
                <select id="terminal-reasoning-select" title="Reasoning"></select>
              </div>
              <div class="terminal-toolbar-extras">
                <button
                  id="terminal-text-input-toggle"
                  class="ghost sm terminal-text-toggle"
                  type="button"
                  aria-controls="terminal-text-input"
                  aria-expanded="false"
                  title="Text input"
                >
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="7" y1="12" x2="17" y2="12"/><line x1="7" y1="8" x2="13" y2="8"/><line x1="7" y1="16" x2="15" y2="16"/></svg>
                  <span class="terminal-text-toggle-label">Text</span>
                </button>
                <div class="terminal-voice">
                  <button id="terminal-voice" class="ghost sm voice-button" title="Hold to talk"></button>
                  <span class="muted small hidden voice-status" id="terminal-voice-status"></span>
                </div>
              </div>
            </div>
          </div>
          <div id="terminal-container" class="terminal-container">
            <div class="terminal-overlay" id="terminal-overlay">
              <p class="muted">Press New or Resume to launch the agent TUI</p>
            </div>
            <button id="terminal-jump-bottom" class="terminal-jump-btn hidden" title="Jump to latest">
              ‚Üì Latest
            </button>
          </div>
          <!-- Mobile control bar - touch-friendly special keys (above text input) -->
          <div id="terminal-mobile-controls" class="terminal-mobile-controls">
            <div class="tmb-row">
              <button class="tmb-key tmb-mod" data-key="ctrl" id="tmb-ctrl">Ctrl</button>
              <button class="tmb-key tmb-mod" data-key="alt" id="tmb-alt">Alt</button>
              <button class="tmb-key" data-seq="&#x1b;">Esc</button>
              <button class="tmb-key" data-seq="&#x09;">Tab</button>
              <button class="tmb-key tmb-primary" data-seq="&#x0d;">Enter</button>
            </div>
            <div class="tmb-row">
              <button class="tmb-key tmb-ctrl-combo" data-ctrl="c">^C</button>
              <button class="tmb-key tmb-ctrl-combo" data-ctrl="d">^D</button>
              <button class="tmb-key tmb-ctrl-combo" data-ctrl="z">^Z</button>
              <button class="tmb-key tmb-bksp" data-seq="&#x7f;">Bksp</button>
              <button class="tmb-key tmb-arrow" data-seq="&#x1b;[D">‚Üê</button>
              <button class="tmb-key tmb-arrow" data-seq="&#x1b;[A">‚Üë</button>
              <button class="tmb-key tmb-arrow" data-seq="&#x1b;[B">‚Üì</button>
              <button class="tmb-key tmb-arrow" data-seq="&#x1b;[C">‚Üí</button>
            </div>
          </div>
          <div id="terminal-text-input" class="terminal-text-input compose-panel hidden" aria-hidden="true">
            <label class="terminal-text-input-title" for="terminal-textarea">Text input</label>
            <div class="terminal-text-input-row compose-row">
              <textarea
                id="terminal-textarea"
                rows="2"
                autocomplete="off"
                autocapitalize="off"
                spellcheck="false"
                enterkeyhint="enter"
                placeholder="Type or paste text/images to send to the terminal‚Ä¶"
              ></textarea>
              <div class="terminal-text-input-buttons compose-buttons">
                <button
                  id="terminal-text-image"
                  class="ghost sm terminal-text-image"
                  type="button"
                  title="Attach image"
                  aria-label="Attach image"
                >Img</button>
                <input
                  id="terminal-text-image-input"
                  class="hidden"
                  type="file"
                  accept="image/*"
                />
                <button
                  id="terminal-text-voice"
                  class="ghost sm voice-button terminal-text-voice"
                  type="button"
                  title="Hold to talk"
                  data-voice-mode="waveform"
                ></button>
                <button
                  id="terminal-text-send"
                  class="primary terminal-text-send-icon"
                  type="button"
                  aria-label="Send"
                >‚Üí</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
    <div id="toast" class="toast"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay" hidden>
      <div
        class="modal-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="confirm-modal-title"
        aria-describedby="confirm-modal-message"
        tabindex="-1"
      >
        <span id="confirm-modal-title" class="sr-only">Confirmation</span>
        <p id="confirm-modal-message"></p>
        <div class="modal-actions">
          <button id="confirm-modal-cancel" class="ghost">Cancel</button>
          <button id="confirm-modal-ok" class="danger">Confirm</button>
        </div>
      </div>
    </div>
    
    <!-- Input Modal -->
    <div id="input-modal" class="modal-overlay" hidden>
      <div
        class="modal-dialog modal-input"
        role="dialog"
        aria-modal="true"
        aria-labelledby="input-modal-title"
        aria-describedby="input-modal-message"
        tabindex="-1"
      >
        <span id="input-modal-title" class="sr-only">Input</span>
        <p id="input-modal-message"></p>
        <input type="text" id="input-modal-input" autocomplete="off" spellcheck="false" />
        <div class="modal-actions">
          <button id="input-modal-cancel" class="ghost">Cancel</button>
          <button id="input-modal-ok" class="primary">OK</button>
        </div>
      </div>
    </div>
    
    <!-- Ingest Spec Modal -->
    <div id="ingest-modal" class="modal-overlay" hidden>
      <div
        class="modal-dialog modal-ingest"
        role="dialog"
        aria-modal="true"
        aria-labelledby="ingest-modal-title"
        aria-describedby="ingest-modal-message"
        tabindex="-1"
      >
        <span id="ingest-modal-title" class="sr-only">Ingest Spec</span>
        <div id="ingest-modal-content">
          <p id="ingest-modal-message">Ready to ingest SPEC into TODO, PROGRESS, and OPINIONS?</p>
          <div id="ingest-modal-refinement" class="ingest-modal-refinement hidden">
            <textarea
              id="ingest-modal-input"
              rows="3"
              placeholder="Refine the ingest (optional)..."
              spellcheck="false"
            ></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button id="ingest-modal-cancel" class="ghost">Cancel</button>
          <button id="ingest-modal-ok" class="primary">Ingest</button>
        </div>
      </div>
    </div>
    
    <!-- Create Repo Modal -->
    <div id="create-repo-modal" class="modal-overlay" hidden>
      <div
        class="modal-dialog modal-create-repo"
        role="dialog"
        aria-modal="true"
        aria-labelledby="create-repo-modal-title"
        aria-describedby="create-repo-modal-body"
        tabindex="-1"
      >
        <div class="modal-header">
          <span class="label" id="create-repo-modal-title">Create New Repository</span>
        </div>
        <div class="modal-body" id="create-repo-modal-body">
          <div class="form-group">
            <label for="create-repo-id">Repo ID <span class="required">*</span></label>
            <input type="text" id="create-repo-id" placeholder="my-project" autocomplete="off" spellcheck="false" />
            <span class="form-hint">Used as directory name if path not specified</span>
          </div>
          <div class="form-group">
            <label for="create-repo-path">Path <span class="optional">(optional)</span></label>
            <input type="text" id="create-repo-path" placeholder="relative/path/to/repo" autocomplete="off" spellcheck="false" />
            <span class="form-hint">Leave empty to use repo ID as path</span>
          </div>
          <div class="form-group">
            <label for="create-repo-url">Git URL <span class="optional">(optional)</span></label>
            <input type="text" id="create-repo-url" placeholder="https://github.com/org/repo.git" autocomplete="off" spellcheck="false" />
            <span class="form-hint">If provided, the repo will be cloned automatically</span>
          </div>
          <div class="form-group form-checkbox">
            <label>
              <input type="checkbox" id="create-repo-git" checked />
              <span>Initialize git repository</span>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button id="create-repo-cancel" class="ghost">Cancel</button>
          <button id="create-repo-submit" class="primary">Create</button>
        </div>
      </div>
    </div>

    <!-- Hub Settings Modal -->
    <div id="hub-settings-modal" class="modal-overlay" hidden>
      <div
        class="modal-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="hub-settings-modal-title"
        aria-describedby="hub-settings-modal-body"
        tabindex="-1"
      >
        <div class="modal-header">
          <span class="label" id="hub-settings-modal-title">Hub Settings</span>
        </div>
        <div class="modal-body" id="hub-settings-modal-body">
          <p class="muted small">System-wide settings for Codex Autorunner.</p>
          <div class="form-group">
            <label>System Update</label>
            <select id="hub-update-target">
              <option value="both">Web + Telegram</option>
              <option value="web">Web only</option>
              <option value="telegram">Telegram only</option>
            </select>
            <button id="hub-update-btn" class="primary sm">Update CAR</button>
            <span class="form-hint">Pull latest code and restart selected services</span>
          </div>
        </div>
        <div class="modal-actions">
          <button id="hub-settings-close" class="ghost">Close</button>
        </div>
      </div>
    </div>

    <!-- Repo Settings Modal -->
    <div id="repo-settings-modal" class="modal-overlay" hidden>
      <div
        class="modal-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="repo-settings-modal-title"
        aria-describedby="repo-settings-modal-body"
        tabindex="-1"
      >
        <div class="modal-header">
          <span class="label" id="repo-settings-modal-title">Repo Settings</span>
        </div>
        <div class="modal-body" id="repo-settings-modal-body">
          <p class="muted small">Settings for the current repository session.</p>
          <div class="form-group">
            <label>System Update</label>
            <select id="repo-update-target">
              <option value="both">Web + Telegram</option>
              <option value="web">Web only</option>
              <option value="telegram">Telegram only</option>
            </select>
            <button id="repo-update-btn" class="primary sm">Update CAR</button>
            <span class="form-hint">Pull latest code and restart selected services</span>
          </div>
          <div class="form-group">
            <label>Autorunner Settings</label>
            <div class="settings-grid">
              <div>
                <label for="autorunner-model-select" class="muted small">Model</label>
                <select id="autorunner-model-select"></select>
              </div>
              <div>
                <label for="autorunner-effort-select" class="muted small">Reasoning effort</label>
                <select id="autorunner-effort-select"></select>
              </div>
              <div>
                <label for="autorunner-approval-select" class="muted small">Approval policy</label>
                <select id="autorunner-approval-select"></select>
              </div>
              <div>
                <label for="autorunner-sandbox-select" class="muted small">Sandbox</label>
                <select id="autorunner-sandbox-select"></select>
              </div>
              <div>
                <label for="autorunner-max-runs-input" class="muted small">Max runs</label>
                <input id="autorunner-max-runs-input" type="number" min="1" step="1" placeholder="Unlimited" />
                <span class="form-hint">Maximum number of autorunner cycles (empty = unlimited)</span>
              </div>
            </div>
            <div id="autorunner-network-row" class="settings-toggle-row">
              <label class="form-checkbox">
                <input id="autorunner-network-toggle" type="checkbox" />
                <span>Allow network access in workspace-write mode</span>
              </label>
            </div>
            <div class="settings-actions">
              <button id="autorunner-settings-save" class="primary sm">Save settings</button>
              <button id="autorunner-settings-reload" class="ghost sm">Reload</button>
            </div>
            <span id="autorunner-settings-warning" class="form-hint warning">Changing these settings starts a new autorunner conversation.</span>
          </div>
          <div class="form-group">
            <label>Thread Tools</label>
            <div id="thread-tools-list" class="thread-tools-list"></div>
            <div class="thread-tools-actions">
              <button id="thread-new-autorunner" class="ghost sm">New autorunner thread</button>
              <button id="thread-archive-autorunner" class="ghost sm">Archive autorunner thread</button>
              <button id="thread-reset-all" class="danger sm">Reset all conversations</button>
              <button id="thread-backup-download" class="ghost sm">Download backup</button>
            </div>
            <span class="form-hint">Resetting conversations clears stored thread IDs and restarts chats.</span>
          </div>
        </div>
        <div class="modal-actions">
          <button id="repo-settings-close" class="ghost">Close</button>
        </div>
      </div>
    </div>

    <div id="run-details-modal" class="modal-overlay" hidden>
      <div
        class="modal-dialog run-details-modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="run-details-title"
        aria-describedby="run-details-meta"
        tabindex="-1"
      >
        <div class="modal-header">
          <span class="label" id="run-details-title">Run</span>
        </div>
        <div class="modal-body">
          <div id="run-details-meta" class="muted small">‚Äì</div>
          <div class="run-details-grid">
            <div class="run-details-section">
              <div class="run-details-title">Completed TODOs</div>
              <div id="run-details-todos" class="run-details-list">‚Äì</div>
            </div>
            <div class="run-details-section">
              <div class="run-details-title">Token breakdown</div>
              <div id="run-details-tokens" class="run-details-list">‚Äì</div>
            </div>
          </div>
          <div class="run-details-section">
            <div class="run-details-title">Plan</div>
            <pre id="run-details-plan" class="run-details-artifact">‚Äì</pre>
          </div>
          <div class="run-details-section">
            <div class="run-details-title">Diff</div>
            <pre id="run-details-diff" class="run-details-artifact">‚Äì</pre>
          </div>
          <div class="run-details-section">
            <div class="run-details-title">Final output</div>
            <pre id="run-details-output" class="run-details-artifact">‚Äì</pre>
          </div>
        </div>
        <div class="modal-actions run-details-actions">
          <a id="run-details-log" class="ghost sm" target="_blank" rel="noreferrer">Open log</a>
          <button id="run-details-close" class="ghost">Close</button>
        </div>
      </div>
    </div>
    
    <script src="static/loader.js?v=__CAR_ASSET_VERSION__" data-car-loader></script>
  </body>
</html>
