# Codex Autorunner - Agent Guide

This repo dogfoods codex-autorunner to build itself. Read this before running the agent loop.

## Layout and key files
- Core package: `src/codex_autorunner/` (engine, CLI, server/API, UI assets).
- Runtime/config/state live under `.codex-autorunner/` (not at repo root):
  - Docs the agent reads/updates: `TODO.md`, `PROGRESS.md`, `OPINIONS.md`, `SPEC.md`, `SUMMARY.md`, `SNAPSHOT.md`.
  - When asked to update any of these docs, you MUST update the copies under `.codex-autorunner/`. Do not create new copies elsewhere.
  - Work doc intent (canonical):
    - TODO: ordered, high-level tasks for agents.
    - PROGRESS: work done + validation notes.
    - OPINIONS: constraints, style, and migration policies.
    - SPEC: source-of-truth requirements and scope.
    - SUMMARY: user-facing report + external/user actions.
    - SNAPSHOT: shareable repo brief (generated by `car snapshot`).
  - `ABOUT_CAR.md`: auto-generated quick reference for interactive sessions (regenerated if the marker is present).
  - Config: `.codex-autorunner/config.yml` (generated).
  - State/log: `.codex-autorunner/state.sqlite3`, `.codex-autorunner/codex-autorunner.log`, `.codex-autorunner/codex-server.log`, `.codex-autorunner/lock`.
  - Hub-only: `.codex-autorunner/manifest.yml`, `.codex-autorunner/hub_state.json`, `.codex-autorunner/codex-autorunner-hub.log`.
- Root defaults: `codex-autorunner.yml`; local overrides: `codex-autorunner.override.yml` (gitignored).
- Config precedence: built-ins < `codex-autorunner.yml` < override < `.codex-autorunner/config.yml` < env.

## CLI commands
- init/run/once/status/log/edit/doctor/resume/kill
- ingest-spec/clear-docs/snapshot/usage
- sessions/stop-session
- serve (API/UI)
- hub: `car hub serve|scan|create` (worktrees via UI/API)

## Docs

Reference docs in `docs/` (e.g., configuration, operations, debugging).

## Python venv
- Always use the project venv (`.venv/bin/python`) for running Python and tests.

## GitHub CLI
- Use the `gh` CLI for GitHub interactions whenever possible.
- Prefer `gh pr create --body-file` (or a here-doc) to preserve PR body newlines.

## Git commits
- Use a 30 second (or longer) timeout for `git commit` commands so pre-commit hooks can finish.
- Avoid `--no-verify` and always err on the side of fixing things; if you must use it, ask the user first; if the fix is simple and non-harmful, make the fix and include it in your changes.

## Releases
- Release workflow details live in `docs/ops/release.md`.

## Make targets
- Prefer running common scripts via `make` targets when available.

## Safe updates (launchd mac hub)
- Preferred path: `scripts/safe-refresh-local-mac-hub.sh` (staged venv swap, launchd reload, `/health` + static/telegram checks, rollback on failure).
- `/system/update` and Telegram `/update` use the safe refresh script when available.
- Common overrides: `UPDATE_TARGET=web|telegram|both`, `HEALTH_CHECK_STATIC=auto|true|false`, `HEALTH_CHECK_TELEGRAM=auto|true|false`, `HEALTH_PATH`, `HEALTH_STATIC_PATH`.
- Do not restart launchd services or run refresh scripts yourself; ask the user to perform restarts.

## Debugging
- Telegram troubleshooting guide: `docs/ops/telegram-debugging.md`

## Dogfooding rules
- We sometimes develop codex-autorunner using itself.
- Note that `.codex-autorunner/` is auto-generated by the CLI tool.
- If the UI reports missing static assets, avoid in-place pip/pipx upgrades on the live venv; use the safe refresher and verify `/health`.
