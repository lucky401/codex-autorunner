# Codex Autorunner - Agent Guide

This repo dogfoods codex-autorunner to build itself. Read this before running the agent loop.

## CAR Constitution
- Default posture: YOLO (full permissions)
- Non-negotiable invariants: filesystem is truth; single source of runtime state under `.codex-autorunner/`; layered architecture (protocol-agnostic engine, adapters, surfaces); prefer determinism and explicit configs; keep diffs small and single-purpose; observability is a contract; agents propose + execute but files decide.
- Quick start: read `docs/car_constitution/61_AGENT_CHEATSHEET.md`.
- Routing: identity/invariants `docs/car_constitution/10_CODEBASE_CONSTITUTION.md`; placement `20_ARCHITECTURE_MAP.md`; change hygiene `30_ENGINEERING_STANDARDS.md`; debugging/timeouts `50_OBSERVABILITY_OPERATIONS.md`; posture `60_AGENT_ONBOARDING.md`; vocabulary `95_GLOSSARY.md`.

## Layout and key files
- Core package: `src/codex_autorunner/` (engine, CLI, server/API, UI assets).
- Frontend JS is generated from TypeScript: edit `static_src/*.ts`, not `static/*.js` (run `pnpm run build` after).
- Runtime/config/state live under `.codex-autorunner/` (not at repo root):
  - Primary work surface: `.codex-autorunner/tickets/TICKET-###.md` (required).
  - Optional contextspace docs (auto-created on write; missing is OK):
    - `.codex-autorunner/contextspace/active_context.md`
    - `.codex-autorunner/contextspace/decisions.md`
    - `.codex-autorunner/contextspace/spec.md`
  - When asked to update tickets/contextspace docs, you MUST update the copies under `.codex-autorunner/`. Do not create new copies elsewhere.
  - Document intent (canonical):
    - Tickets: ordered units of work and the main execution surface.
    - active_context: short-lived context for the current effort.
    - decisions: durable architectural/product decisions and constraints.
    - spec: source-of-truth requirements used to generate tickets.
  - `ABOUT_CAR.md`: auto-generated quick reference for interactive sessions (regenerated if the marker is present).
  - Config: `.codex-autorunner/config.yml` (generated).
  - State/log: `.codex-autorunner/state.sqlite3`, `.codex-autorunner/codex-autorunner.log`, `.codex-autorunner/codex-server.log`, `.codex-autorunner/lock`.
  - Hub-only: `.codex-autorunner/manifest.yml`, `.codex-autorunner/hub_state.json`, `.codex-autorunner/codex-autorunner-hub.log`.
- Root defaults: `codex-autorunner.yml`; local overrides: `codex-autorunner.override.yml` (gitignored).
- Config precedence: built-ins < `codex-autorunner.yml` < override < `.codex-autorunner/config.yml` < env.

## CLI commands
- init/run/once/status/log/edit/doctor/resume/kill
- usage
- sessions/stop-session
- serve (API/UI)
- hub: `car hub serve|scan|create` (worktrees via UI/API)

## Docs

Reference docs in `docs/` (e.g., configuration, operations, debugging).

## Worktree archives
- Snapshots live under `.codex-autorunner/archive/worktrees/<worktree_repo_id>/<snapshot_id>/` in the base repo.
- Archives are local runtime artifacts (gitignored, not committed).
- Worktree cleanup archives by default; failures abort cleanup unless `force_archive` is set.
- Browse snapshots in the web UI Archive tab (repo view).
- More details: `docs/ops/worktree-archives.md`.

## Python venv
- Run `make setup` to initialize the venv and dependencies if not already set up.
- Always use the project venv (`.venv/bin/python`) for running Python and tests.

## GitHub CLI
- Use the `gh` CLI for GitHub interactions whenever possible.
- Prefer `gh pr create --body-file` (or a here-doc) to preserve PR body newlines.

## Git commits
- Use a 30 second (or longer) timeout for `git commit` commands so pre-commit hooks can finish.
- Avoid `--no-verify` and always err on the side of fixing things; if you must use it, ask the user first; if the fix is simple and non-harmful, make the fix and include it in your changes.

## Releases
- Release workflow details live in `docs/ops/release.md`.

## Make targets
- Prefer running common scripts via `make` targets when available.

## Safe updates (launchd mac hub)
- Preferred path: `scripts/safe-refresh-local-mac-hub.sh` (staged venv swap, launchd reload, `/health` + static/telegram checks, rollback on failure).
- `/system/update` and Telegram `/update` use the safe refresh script when available.
- Common overrides: `UPDATE_TARGET=web|telegram|both`, `HEALTH_CHECK_STATIC=auto|true|false`, `HEALTH_CHECK_TELEGRAM=auto|true|false`, `HEALTH_PATH`, `HEALTH_STATIC_PATH`.
- Do not restart launchd services or run refresh scripts yourself; ask the user to perform restarts.

## Debugging
- Telegram troubleshooting guide: `docs/ops/telegram-debugging.md`

## Subagent Model Configuration
- See `docs/adding-an-agent.md` for the review/subagent model setup and YAML example.

## Dogfooding rules
- We sometimes develop codex-autorunner using itself.
- Note that `.codex-autorunner/` is auto-generated by the CLI tool.
- If the UI reports missing static assets, avoid in-place pip/pipx upgrades on the live venv; use the safe refresher and verify `/health`.
