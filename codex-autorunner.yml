# Root defaults for codex-autorunner.
# - This file is committed and documents every adjustable value.
# - Optional local overrides live in codex-autorunner.override.yml (gitignored).
# - Precedence: built-in defaults < this file < override file < .codex-autorunner/config.yml < env vars.
# - .codex-autorunner/config.yml is GENERATED by CAR; edit this file to change what CAR generates.
# - Do not put secrets in this file. Use env vars or the gitignored override file.

version: 2
mode: hub

# Repo defaults applied to all repos unless overridden.
repo_defaults:
  docs:
    # Paths are relative to the repo root.
    # Example: .codex-autorunner/TODO.md → /repo/root/.codex-autorunner/TODO.md
    # Note: Absolute paths and ~ expansion are NOT allowed for docs.*
    todo: .codex-autorunner/TODO.md
    progress: .codex-autorunner/PROGRESS.md
    opinions: .codex-autorunner/OPINIONS.md
    spec: .codex-autorunner/SPEC.md
    summary: .codex-autorunner/SUMMARY.md
    snapshot: .codex-autorunner/SNAPSHOT.md
    snapshot_state: .codex-autorunner/snapshot_state.json

  codex:
    # Codex CLI binary to invoke.
    binary: codex
    # Default args for codex-autorunner runs.
    # NOTE: --sandbox danger-full-access is powerful; change only if you understand the tradeoffs.
    args:
      - --yolo
      - exec
      - --sandbox
      - danger-full-access
    # Default args for manual terminal sessions.
    terminal_args:
      - --yolo
    # Optional model selection; null means "use Codex profile default".
    model: null
    reasoning: null
    models:
      small: gpt-5.1-codex-mini
      large: null

  prompt:
    # Max characters of previous run output to include.
    prev_run_max_chars: 6000
    # Custom prompt template path (relative to repo root). null = use built-in.
    # Example: .codex-autorunner/prompt.txt → /repo/root/.codex-autorunner/prompt.txt
    template: .codex-autorunner/prompt.txt

  runner:
    # Sleep between loop iterations.
    sleep_seconds: 5
    # Stop after N runs (null = never).
    stop_after_runs: null
    # Stop after wallclock seconds (null = no limit).
    max_wallclock_seconds: null

  git:
    # Auto-commit after a run.
    auto_commit: false
    commit_message_template: "[codex] run #{run_id}"

  github:
    # Enable GitHub integration endpoints.
    enabled: true
    # Default to draft PRs.
    pr_draft_default: true
    # none|auto|always
    sync_commit_mode: auto
    # Bounds the agentic sync step (seconds).
    sync_agent_timeout_seconds: 1800

  notifications:
    # enabled: true|false|"auto" (auto enables if any target env vars are present)
    enabled: auto
    # List of events to notify; use ["all"] to receive every event.
    events:
      - run_finished
      - run_error
      - tui_idle
    # Idle time (seconds) after last TUI output before notifying.
    tui_idle_seconds: 60
    discord:
      webhook_url_env: CAR_DISCORD_WEBHOOK_URL
    telegram:
      bot_token_env: CAR_TELEGRAM_BOT_TOKEN
      chat_id_env: CAR_TELEGRAM_CHAT_ID
      thread_id_env: CAR_TELEGRAM_THREAD_ID
      thread_id: null
      thread_id_map: {}

  voice:
    # Voice input via Whisper.
    enabled: true
    provider: openai_whisper
    latency_mode: balanced
    chunk_ms: 600
    sample_rate: 16000
    # Warn if a remote API will be called without explicit opt-in.
    warn_on_remote_api: true
    push_to_talk:
      max_ms: 15000
      silence_auto_stop_ms: 1200
      min_hold_ms: 150
    providers:
      openai_whisper:
        # Environment variable name for the API key (set the key in your shell or launchd).
        api_key_env: OPENAI_API_KEY
        model: whisper-1
        base_url: null
        temperature: 0
        language: null
        redact_request: true

  log:
    # Path is relative to the repo root.
    # Example: .codex-autorunner/codex-autorunner.log → /repo/root/.codex-autorunner/codex-autorunner.log
    path: .codex-autorunner/codex-autorunner.log
    max_bytes: 10000000
    backup_count: 3

  server_log:
    # Path is relative to the repo root.
    # Example: .codex-autorunner/codex-server.log → /repo/root/.codex-autorunner/codex-server.log
    path: .codex-autorunner/codex-server.log
    max_bytes: 10000000
    backup_count: 3

agents:
  # Agent binaries/commands (add new agents here; do not hardcode).
  codex:
    binary: codex
  opencode:
    binary: opencode
    # Optional: override the default serve command derived from binary.
    # serve_command:
    #   - /absolute/path/to/opencode
    #   - serve
    #   - --hostname
    #   - 127.0.0.1
    #   - --port
    #   - "0"

terminal:
  # Idle timeout for terminal sessions (seconds).
  idle_timeout_seconds: 43200

telegram_bot:
  # Telegram bot integration (polling).
  enabled: false
  mode: polling
  bot_token_env: CAR_TELEGRAM_BOT_TOKEN
  chat_id_env: CAR_TELEGRAM_CHAT_ID
  # Message formatting (HTML|Markdown|MarkdownV2). Set to ""/null to disable.
  parse_mode: HTML
  allowed_chat_ids: []
  allowed_user_ids: []
  require_topics: false
  defaults:
    approval_mode: yolo
    approval_policy: on-request
    sandbox_policy: dangerFullAccess
    yolo_approval_policy: never
    yolo_sandbox_policy: dangerFullAccess
  concurrency:
    max_parallel_turns: 5
    per_topic_queue: true
  shell:
    # Allow !<cmd> execution (enabled by default).
    enabled: true
    # Timeout for shell commands (ms).
    timeout_ms: 120000
    # Max output characters to show inline before attaching full output.
    max_output_chars: 3800
  command_registration:
    # Auto-register bot commands so Telegram shows the slash command menu.
    enabled: true
    scopes:
      - type: default
        language_code: ""
      - type: all_group_chats
        language_code: ""
  state_file: .codex-autorunner/telegram_state.json
  # Optional env var that contains the full app-server command.
  app_server_command_env: CAR_TELEGRAM_APP_SERVER_COMMAND
  app_server_command:
    - codex
    - app-server
  app_server:
    # Close idle app-server handles after this many seconds; null/<=0 disables pruning.
    idle_ttl_seconds: 28800
  polling:
    timeout_seconds: 30
    allowed_updates:
      - message
      - edited_message
      - callback_query

hub:
  # Hub repo discovery root (relative to config file location).
  # Example: . → /repo/root/ (where codex-autorunner.yml is located)
  repos_root: .
  # Hub-managed git worktrees live here (depth=1 scan).
  # Relative to config file location.
  worktrees_root: worktrees
  # Manifest path for the hub (relative to repo root).
  manifest: .codex-autorunner/manifest.yml
  discover_depth: 1
  auto_init_missing: true
  # When serving repos via the hub, reuse hub server security settings.
  repo_server_inherit: true
  # Where to pull system updates from (main upstream).
  update_repo_url: https://github.com/Git-on-my-level/codex-autorunner.git
  update_repo_ref: main
  log:
    path: .codex-autorunner/codex-autorunner-hub.log
    max_bytes: 10000000
    backup_count: 3

app_server:
  # Command used to start the Codex app-server.
  command:
    - codex
    - app-server
  # Workspace state root (stores per-repo CODEX_HOME state).
  # Supports ~ expansion: ~/.codex-autorunner/workspaces → /home/user/.codex-autorunner/workspaces
  # Can also be relative to repo root: .codex-autorunner/workspaces
  state_root: ~/.codex-autorunner/workspaces
  # Cap concurrent handles; null/<=0 disables the cap.
  max_handles: 20
  # Close idle app-server handles after this many seconds; null/<=0 disables pruning.
  idle_ttl_seconds: 3600
  # Per-turn timeout for app-server runs (seconds); null/<=0 disables.
  turn_timeout_seconds: 28800
  # Per-request timeout (seconds); null/<=0 uses the client default.
  request_timeout: null
  # Prompt limits for app-server flows (doc chat, spec ingest, autorunner).
  prompts:
    doc_chat:
      max_chars: 12000
      message_max_chars: 2000
      target_excerpt_max_chars: 4000
      recent_summary_max_chars: 2000
    spec_ingest:
      max_chars: 12000
      message_max_chars: 2000
      spec_excerpt_max_chars: 5000
    autorunner:
      max_chars: 16000
      message_max_chars: 2000
      todo_excerpt_max_chars: 4000
      prev_run_max_chars: 3000

server:
  # Bind host/port for the local UI/API. Use 0.0.0.0 only if you intend to expose it.
  host: 127.0.0.1
  port: 4173
  # Optional base path for reverse proxies ("" or "/car").
  base_path: ""
  # Disable uvicorn access logs by default to avoid logging query params.
  access_log: false
  # Optional env var containing the bearer token required for /api and websocket access.
  auth_token_env: ""
  # Allowed Host header values; empty uses loopback defaults when bound to loopback.
  allowed_hosts: []
  # Allowed Origin values for unsafe requests; empty enforces same-origin only.
  allowed_origins: []

# Optional explicit server log for the hub (null uses hub.log only).
server_log: null

static_assets:
  # Cache root for static assets (relative to repo root or ~ expansion).
  # Example: .codex-autorunner/static-cache → /repo/root/.codex-autorunner/static-cache
  # Example with ~: ~/.codex-autorunner/static-cache → /home/user/.codex-autorunner/static-cache
  cache_root: .codex-autorunner/static-cache
  max_cache_entries: 5
  max_cache_age_days: 30

housekeeping:
  enabled: true
  interval_seconds: 3600
  min_file_age_seconds: 600
  dry_run: false
  rules:
    # Note: housekeeping rule paths support both:
    # - Relative paths: .codex-autorunner/runs → /repo/root/.codex-autorunner/runs
    # - ~ expansion: ~/.codex-autorunner/update_cache → /home/user/.codex-autorunner/update_cache
    # Absolute paths and .. segments are NOT allowed.
    - name: run_logs
      kind: directory
      path: .codex-autorunner/runs
      glob: run-*.log
      recursive: false
      max_files: 200
      max_total_bytes: 500000000
      max_age_days: 30
    - name: terminal_image_uploads
      kind: directory
      path: .codex-autorunner/uploads/terminal-images
      glob: "*"
      recursive: false
      max_files: 500
      max_total_bytes: 200000000
      max_age_days: 14
    - name: telegram_images
      kind: directory
      path: .codex-autorunner/uploads/telegram-images
      glob: "*"
      recursive: false
      max_files: 500
      max_total_bytes: 200000000
      max_age_days: 14
    - name: telegram_voice
      kind: directory
      path: .codex-autorunner/uploads/telegram-voice
      glob: "*"
      recursive: false
      max_files: 500
      max_total_bytes: 500000000
      max_age_days: 14
    - name: telegram_files
      kind: directory
      path: .codex-autorunner/uploads/telegram-files
      glob: "*"
      recursive: true
      max_files: 500
      max_total_bytes: 500000000
      max_age_days: 14
    - name: github_context
      kind: directory
      path: .codex-autorunner/github_context
      glob: "*"
      recursive: false
      max_files: 200
      max_total_bytes: 100000000
      max_age_days: 30
    - name: update_cache
      kind: directory
      path: ~/.codex-autorunner/update_cache
      glob: "*"
      recursive: true
      max_files: 2000
      max_total_bytes: 1000000000
      max_age_days: 30
    - name: update_log
      kind: file
      path: ~/.codex-autorunner/update-standalone.log
      max_bytes: 5000000
