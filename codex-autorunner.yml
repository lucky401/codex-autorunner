# Root defaults for codex-autorunner.
# - This file is committed and documents every adjustable value.
# - Optional local overrides live in codex-autorunner.override.yml (gitignored).
# - Precedence: built-in defaults < this file < override file < .codex-autorunner/config.yml < env vars.
# - .codex-autorunner/config.yml is GENERATED by CAR; edit this file to change what CAR generates.
# - Do not put secrets in this file. Use env vars or the gitignored override file.

version: 2
mode: hub

# Repo defaults applied to all repos unless overridden.
repo_defaults:
  docs:
    # Paths are relative to the repo root.
    # Note: Absolute paths and ~ expansion are NOT allowed for docs.*
    active_context: .codex-autorunner/contextspace/active_context.md
    decisions: .codex-autorunner/contextspace/decisions.md
    spec: .codex-autorunner/contextspace/spec.md

  codex:
    # Codex CLI binary to invoke.
    binary: codex
    # Default args for codex-autorunner runs.
    # NOTE: --sandbox danger-full-access is powerful; change only if you understand the tradeoffs.
    args:
      - --yolo
      - exec
      - --sandbox
      - danger-full-access
    # Default args for manual terminal sessions.
    terminal_args:
      - --yolo
    # Optional model selection; null means "use Codex profile default".
    model: null
    reasoning: null
    models:
      small: gpt-5.1-codex-mini
      large: null

  prompt:
    # Max characters of previous run output to include.
    prev_run_max_chars: 6000
    # Custom prompt template path (relative to repo root). null = use built-in.
    # Example: .codex-autorunner/prompt.txt → /repo/root/.codex-autorunner/prompt.txt
    template: .codex-autorunner/prompt.txt

  ui:
    # Default editor used when VISUAL/EDITOR are unset.
    editor: vi

  runner:
    # Sleep between loop iterations.
    sleep_seconds: 5
    # Stop after N runs (null = never).
    stop_after_runs: null
    # Stop after wallclock seconds (null = no limit).
    max_wallclock_seconds: null

  autorunner:
    # Reuse app-server sessions across autorunner runs. Default is stateless.
    reuse_session: false

  ticket_flow:
    # Configurable prefix for ticket filenames (QC, JIRA, TICKET, etc.)
    # Example: ticket_prefix: QC → QC-001.md, QC-002.md
    # Default: TICKET → TICKET-001.md, TICKET-002.md
    ticket_prefix: TICKET
    # Keep ticket_flow deterministic by default; surfaces can tighten this.
    default_approval_decision: accept
    # Include previous ticket content in prompts (disabled by default to keep tickets isolated).
    # When enabled, previous ticket content is truncated to 16KB and clearly labeled.
    # Prefer using contextspace docs (active_context.md, decisions.md, spec.md) for cross-ticket context.
    include_previous_ticket_context: false
    # Branch naming template for auto-creating branches on ticket start.
    # Available variables: {ticket_code} (e.g., TICKET-001), {title_slug} (slugified title)
    # Set to null to disable auto-branch creation.
    # Example: "helios/{ticket_code}-{title_slug}" → helios/TICKET-001-add-auth
    branch_template: null

  git:
    # Auto-commit after a run.
    auto_commit: false
    # Commit message template for auto-commits.
    # Available variables: {run_id}, {turn}, {agent}, {ticket_code}
    # Example: "[DONE][{ticket_code}][{agent}] turn {turn}"
    commit_message_template: "[codex] run #{run_id}"

  github:
    # Enable GitHub integration endpoints.
    enabled: true
    # Default to draft PRs.
    pr_draft_default: true
    # none|auto|always
    sync_commit_mode: auto
    # Bounds the agentic sync step (seconds).
    sync_agent_timeout_seconds: 1800

  bitbucket:
    # Enable Bitbucket integration for automatic PR creation.
    enabled: false
    # Bearer token for Bitbucket API (use env var for secrets).
    # Example: CAR_BITBUCKET_ACCESS_TOKEN
    access_token_env: CAR_BITBUCKET_ACCESS_TOKEN
    # Default reviewers (Bitbucket account UUIDs or usernames).
    default_reviewers: []
    # Close source branch after PR merge.
    close_source_branch: true
    # Default destination branch for PRs.
    default_dest_branch: main

  notifications:
    # enabled: true|false|"auto" (auto enables if any target env vars are present)
    enabled: auto
    # List of events to notify; use ["all"] to receive every event.
    events:
      - run_finished
      - run_error
      - tui_idle
    # Request timeout for notification delivery (seconds).
    timeout_seconds: 5.0
    # Idle time (seconds) after last TUI output before notifying.
    tui_idle_seconds: 60
    discord:
      webhook_url_env: CAR_DISCORD_WEBHOOK_URL
    telegram:
      bot_token_env: CAR_TELEGRAM_BOT_TOKEN
      chat_id_env: CAR_TELEGRAM_CHAT_ID
      thread_id_env: CAR_TELEGRAM_THREAD_ID
      thread_id: null
      thread_id_map: {}

  voice:
    # Voice input via Whisper.
    enabled: true
    provider: openai_whisper
    latency_mode: balanced
    chunk_ms: 600
    sample_rate: 16000
    # Warn if a remote API will be called without explicit opt-in.
    warn_on_remote_api: true
    push_to_talk:
      max_ms: 15000
      silence_auto_stop_ms: 1200
      min_hold_ms: 150
    providers:
      openai_whisper:
        # Environment variable name for the API key (set the key in your shell or launchd).
        api_key_env: OPENAI_API_KEY
        model: whisper-1
        base_url: null
        temperature: 0
        language: null
        redact_request: true

  log:
    # Path is relative to the repo root.
    # Example: .codex-autorunner/codex-autorunner.log → /repo/root/.codex-autorunner/codex-autorunner.log
    path: .codex-autorunner/codex-autorunner.log
    max_bytes: 10000000
    backup_count: 3

  server_log:
    # Path is relative to repo root.
    # Example: .codex-autorunner/codex-server.log → /repo/root/.codex-autorunner/codex-server.log
    path: .codex-autorunner/codex-server.log
    max_bytes: 10000000
    backup_count: 3

  review:
    enabled: true
    agent: opencode
    # Model for parent coordinator agent
    model: zai-coding-plan/glm-5
    # Agent ID to use for subtasks (bucket reviews, pruning agents)
    subagent_agent: subagent
    # Model to use for subagents (default to model if not specified)
    subagent_model: zai-coding-plan/glm-4.7-flashx
    reasoning: null
    max_wallclock_seconds: null

  usage:
    # Cache scope for aggregated usage series: global|repo
    cache_scope: global
    # Override global CODEX_HOME for usage cache (null = CODEX_HOME env or ~/.codex)
    global_cache_root: null
    # Repo-local cache path (relative to repo root).
    repo_cache_path: .codex-autorunner/usage/usage_series_cache.json

agents:
  # Agent binaries/commands (add new agents here; do not hardcode).
  codex:
    binary: codex
  opencode:
    binary: opencode
    # Optional: map subagent agent IDs to models
    # Example: subagent_models: { subagent: zai-coding-plan/glm-4.7-flashx }
    # This allows different models for parent vs subagent sessions
    subagent_models:
      subagent: zai-coding-plan/glm-4.7-flashx
    # Optional: override the default serve command derived from binary.
    # serve_command:
    #   - /absolute/path/to/opencode
    #   - serve
    #   - --hostname
    #   - 127.0.0.1
    #   - --port
    #   - "0"

templates:
  # Template repositories used by `car templates` commands.
  enabled: true
  repos:
    - id: blessed
      url: https://github.com/Git-on-my-level/car-ticket-templates
      trusted: true
      default_ref: main

pma:
  # Project Management Assistant (hub-level chat + filebox).
  # When disabled, PMA routes return 404 and Telegram /pma is blocked.
  enabled: true
  # Default agent for PMA chat (codex|opencode).
  default_agent: codex
  # Optional model override; null uses agent's default model.
  model: null
  # Optional reasoning effort for compatible agents (null = agent default).
  reasoning: null
  # Max characters loaded from PMA docs (AGENTS/active_context/context_log tail).
  # Lower values reduce prompt-injection surface and keep prompts lean.
  docs_max_chars: 12000
  # Max lines shown/edited for active_context.md in the PMA docs UI.
  # Lower values keep the manual editor and prompt budget predictable.
  active_context_max_lines: 200
  # Tail lines pulled from context_log.md for PMA prompt context.
  # Lower values bound history and reduce prompt-injection surface.
  context_log_tail_lines: 120
  # Max upload size for PMA filebox (bytes).
  max_upload_bytes: 10000000
  # Enable PMA dispatch interception (auto-resolve trivial dispatches before user notification).
  # When enabled, PMA intercepts dispatches and auto-resolves matching ones.
  dispatch_interception_enabled: false

terminal:
  # Idle timeout for terminal sessions (seconds).
  idle_timeout_seconds: 43200

telegram_bot:
  # Telegram bot integration (polling).
  enabled: false
  mode: polling
  bot_token_env: CAR_TELEGRAM_BOT_TOKEN
  chat_id_env: CAR_TELEGRAM_CHAT_ID
  # Message formatting (HTML|Markdown|MarkdownV2). Set to ""/null to disable.
  parse_mode: HTML
  allowed_chat_ids: []
  allowed_user_ids: []
  require_topics: false
  # When set to 'mentions', only start runs when explicitly invoked (e.g. @botname mention or reply).
  trigger_mode: all
  defaults:
    approval_mode: yolo
    approval_policy: on-request
    sandbox_policy: dangerFullAccess
    yolo_approval_policy: never
    yolo_sandbox_policy: dangerFullAccess
  concurrency:
    max_parallel_turns: 5
    per_topic_queue: true
  shell:
    # Allow !<cmd> execution (enabled by default).
    enabled: true
    # Timeout for shell commands (ms).
    timeout_ms: 120000
    # Max output characters to show inline before attaching full output.
    max_output_chars: 3800
  cache:
    # Cache cleanup cadence (seconds).
    cleanup_interval_seconds: 300
    # TTLs for in-memory Telegram state (seconds).
    coalesce_buffer_ttl_seconds: 60
    media_batch_buffer_ttl_seconds: 60
    model_pending_ttl_seconds: 1800
    pending_approval_ttl_seconds: 600
    pending_question_ttl_seconds: 600
    reasoning_buffer_ttl_seconds: 900
    selection_state_ttl_seconds: 1800
    turn_preview_ttl_seconds: 900
    progress_stream_ttl_seconds: 900
    oversize_warning_ttl_seconds: 3600
    update_id_persist_interval_seconds: 60
  command_registration:
    # Auto-register bot commands so Telegram shows the slash command menu.
    enabled: true
    scopes:
      - type: default
        language_code: ""
      - type: all_group_chats
        language_code: ""
  # Optional full OpenCode command (overrides agent binary for Telegram sessions).
  opencode_command: null
  state_file: .codex-autorunner/telegram_state.sqlite3
  # Optional env var that contains the full app-server command.
  app_server_command_env: CAR_TELEGRAM_APP_SERVER_COMMAND
  app_server_command:
    - codex
    - app-server
  app_server:
    # Close idle app-server handles after this many seconds; null/<=0 disables pruning.
    idle_ttl_seconds: 28800
  # Per-agent turn timeout (seconds); null/<=0 disables for that agent.
  agent_timeouts:
    codex: 28800
    opencode: 28800
  polling:
    timeout_seconds: 30
    # HTTP request timeout for getUpdates (should exceed timeout_seconds).
    request_timeout_seconds: null
    allowed_updates:
      - message
      - edited_message
      - callback_query
  # Pause dispatch notifications
  pause_dispatch_notifications:
    enabled: true
    send_attachments: true
    max_file_size_bytes: 50000000
    chunk_long_messages: true
  # Default chat for workspaces without bound topics (Telegram chat id)
  default_notification_chat_id: null

hub:
  # Hub repo discovery root (relative to config file location).
  # Example: . → /repo/root/ (where codex-autorunner.yml is located)
  repos_root: .
  # Hub-managed git worktrees live here (depth=1 scan).
  # Relative to config file location.
  worktrees_root: worktrees
  # Manifest path for the hub (relative to repo root).
  manifest: .codex-autorunner/manifest.yml
  discover_depth: 1
  auto_init_missing: true
  # When serving repos via the hub, reuse hub server security settings.
  repo_server_inherit: true
  # Where to pull system updates from (main upstream).
  update_repo_url: https://github.com/Git-on-my-level/codex-autorunner.git
  update_repo_ref: main
  log:
    path: .codex-autorunner/codex-autorunner-hub.log
    max_bytes: 10000000
    backup_count: 3

update:
  # Skip running ./scripts/check.sh during system updates.
  skip_checks: false

usage:
  # Cache scope for aggregated usage series: global|repo
  cache_scope: global
  # Override global CODEX_HOME for usage cache (null = CODEX_HOME env or ~/.codex)
  global_cache_root: null
  # Hub-level cache path (relative to repo root).
  repo_cache_path: .codex-autorunner/usage/usage_series_cache.json

app_server:
  # Command used to start the Codex app-server.
  command:
    - codex
    - app-server
  # Workspace state root (stores per-repo CODEX_HOME state).
  # Supports ~ expansion: ~/.codex-autorunner/workspaces → /home/user/.codex-autorunner/workspaces
  # Can also be relative to repo root: .codex-autorunner/workspaces
  state_root: ~/.codex-autorunner/workspaces
  # Whether to auto-restart the app-server after unexpected exits.
  auto_restart: true
  # Cap concurrent handles; null/<=0 disables the cap.
  max_handles: 20
  # Close idle app-server handles after this many seconds; null/<=0 disables pruning.
  idle_ttl_seconds: 3600
  # Per-turn timeout for app-server runs (seconds); null/<=0 disables.
  turn_timeout_seconds: 28800
  # Per-request timeout (seconds); null/<=0 uses the client default.
  request_timeout: null
  client:
    # Max bytes for a single JSON-RPC message from the app-server.
    max_message_bytes: 52428800
    # Max bytes kept for oversize message previews.
    oversize_preview_bytes: 4096
    # Cap bytes drained when discarding oversized messages.
    max_oversize_drain_bytes: 104857600
    # Restart backoff tuning (seconds).
    restart_backoff_initial_seconds: 0.5
    restart_backoff_max_seconds: 30.0
    # Jitter ratio applied to restart delays (0 disables jitter).
    restart_backoff_jitter_ratio: 0.1
  # Prompt limits for app-server flows (doc chat, spec ingest, autorunner).
  prompts:
    doc_chat:
      max_chars: 12000
      message_max_chars: 2000
      target_excerpt_max_chars: 4000
      recent_summary_max_chars: 2000
    spec_ingest:
      max_chars: 12000
      message_max_chars: 2000
      spec_excerpt_max_chars: 5000
    autorunner:
      max_chars: 16000
      message_max_chars: 2000
      todo_excerpt_max_chars: 4000
      prev_run_max_chars: 3000

opencode:
  # Max characters per OpenCode message part (client-side chunking). null/<=0 disables.
  max_text_chars: 20000
  # Per-connection timeout for OpenCode stream stalls (seconds). null/<=0 disables.
  session_stall_timeout_seconds: null

server:
  # Bind host/port for the local UI/API. Use 0.0.0.0 only if you intend to expose it.
  host: 127.0.0.1
  port: 4173
  # Optional base path for reverse proxies ("" or "/car").
  base_path: ""
  # Disable uvicorn access logs by default to avoid logging query params.
  access_log: false
  # Optional env var containing the bearer token required for /api and websocket access.
  auth_token_env: ""
  # Allowed Host header values; empty uses loopback defaults when bound to loopback.
  allowed_hosts: []
  # Allowed Origin values for unsafe requests; empty enforces same-origin only.
  allowed_origins: []

# Optional explicit server log for the hub (null uses hub.log only).
server_log: null

static_assets:
  # Cache root for static assets (relative to repo root or ~ expansion).
  # Example: .codex-autorunner/static-cache → /repo/root/.codex-autorunner/static-cache
  # Example with ~: ~/.codex-autorunner/static-cache → /home/user/.codex-autorunner/static-cache
  cache_root: .codex-autorunner/static-cache
  max_cache_entries: 5
  max_cache_age_days: 30

housekeeping:
  enabled: true
  interval_seconds: 3600
  min_file_age_seconds: 600
  dry_run: false
  rules:
    # Note: housekeeping rule paths support both:
    # - Relative paths: .codex-autorunner/runs → /repo/root/.codex-autorunner/runs
    # - ~ expansion: ~/.codex-autorunner/update_cache → /home/user/.codex-autorunner/update_cache
    # Absolute paths and .. segments are NOT allowed.
    - name: run_logs
      kind: directory
      path: .codex-autorunner/runs
      glob: run-*.log
      recursive: false
      max_files: 200
      max_total_bytes: 500000000
      max_age_days: 30
    - name: terminal_image_uploads
      kind: directory
      path: .codex-autorunner/uploads/terminal-images
      glob: "*"
      recursive: false
      max_files: 500
      max_total_bytes: 200000000
      max_age_days: 14
    - name: telegram_images
      kind: directory
      path: .codex-autorunner/uploads/telegram-images
      glob: "*"
      recursive: false
      max_files: 500
      max_total_bytes: 200000000
      max_age_days: 14
    - name: telegram_voice
      kind: directory
      path: .codex-autorunner/uploads/telegram-voice
      glob: "*"
      recursive: false
      max_files: 500
      max_total_bytes: 500000000
      max_age_days: 14
    - name: telegram_files
      kind: directory
      path: .codex-autorunner/uploads/telegram-files
      glob: "*"
      recursive: true
      max_files: 500
      max_total_bytes: 500000000
      max_age_days: 14
    - name: github_context
      kind: directory
      path: .codex-autorunner/github_context
      glob: "*"
      recursive: false
      max_files: 200
      max_total_bytes: 100000000
      max_age_days: 30
    - name: update_cache
      kind: directory
      path: ~/.codex-autorunner/update_cache
      glob: "*"
      recursive: true
      max_files: 2000
      max_total_bytes: 1000000000
      max_age_days: 30
    - name: update_log
      kind: file
      path: ~/.codex-autorunner/update-standalone.log
      max_bytes: 5000000
