{"author":{"id":"MDQ6VXNlcjkzODcyNTI=","is_bot":false,"login":"Git-on-my-level","name":"David Zhang"},"body":"We currently have a few places where we can accrue static files, we should make sure they stay bounded in disk size\n\nWe can configure a \"max disk space\" or \"max num files\" or \"max log lines\" or whatever depending on file type in our config file, then have a background job or something that does this kind of housekeeping work\n\nSome examples of file types to consider\n- logs\n- file uploads\n- whisper voice files\n- github context files\n- anything else that we probably don't need forever that's for cache or otherwise purposes\n\n## Disk housekeeping to bound on-disk artifacts\n\n### Problem\n\nWe have several places where static artifacts can grow without bound and eventually exhaust disk:\n\nCurrent on-disk accumulation points (in this repo):\n\n* **Per-run logs**: `Engine` writes `.codex-autorunner/runs/run-<id>.log` (never pruned today).\n\n  * Source: `src/codex_autorunner/engine.py` (`_run_log_path()`, `_ensure_run_log_dir()`)\n* **Web terminal image uploads**: `.codex-autorunner/uploads/terminal-images/*`\n\n  * Source: `src/codex_autorunner/routes/terminal_images.py`\n* **Telegram media saved to disk**\n\n  * Voice: `.codex-autorunner/uploads/telegram-voice/*`\n  * Images: `.codex-autorunner/uploads/telegram-images/*`\n  * Source: `src/codex_autorunner/telegram_bot.py` (`_voice_storage_dir()`, `_image_storage_dir()`)\n* **System update artifacts**\n\n  * Update log: `~/.codex-autorunner/update-standalone.log`\n  * Update cache: `~/.codex-autorunner/update_cache/`\n  * Source: `src/codex_autorunner/routes/system.py` (`_spawn_update_process()`, etc.)\n\nNotes:\n\n* Main logs already have size-bounded rotation via `LogConfig` (`setup_rotating_logger`), but the **run logs** + **uploads** do not.\n* Telegram voice files appear to be deleted in many flows, but images are not, and voice files can still leak on failures.\n\n---\n\n### Goals\n\n* Add **configurable limits** (max bytes, max files, max age, etc.) per artifact type.\n* Run housekeeping **automatically** (background job) in long-lived processes:\n\n  * repo server (FastAPI app)\n  * hub server (FastAPI hub app)\n  * telegram bot process\n* Ensure housekeeping is **safe** (avoid deleting actively-written files) and **observable** (logs what it removed).\n\n### Non-goals\n\n* Do not delete user-authored work docs under `.codex-autorunner/*.md`.\n* Do not delete repo source code, git worktrees, or anything not explicitly “cache/upload/log artifact”.\n\n---\n\n## Proposed design\n\n### 1) New config section: `housekeeping`\n\nAdd a new config block to `.codex-autorunner/config.yml` with:\n\n* global enable/disable\n* interval\n* minimum “grace” age (don’t delete files modified recently)\n* per-target rules (directory rules + optional single-file rules)\n\nExample schema (illustrative):\n\n```yaml\nhousekeeping:\n  enabled: true\n  interval_seconds: 3600\n  min_file_age_seconds: 600   # never delete files modified in last 10m\n  dry_run: false              # if true: log what would be deleted\n\n  rules:\n    - name: run_logs\n      kind: directory\n      path: \".codex-autorunner/runs\"\n      glob: \"run-*.log\"\n      recursive: false\n      max_files: 200\n      max_total_bytes: 500000000   # 500MB\n      max_age_days: 30\n\n    - name: terminal_image_uploads\n      kind: directory\n      path: \".codex-autorunner/uploads/terminal-images\"\n      glob: \"*\"\n      recursive: false\n      max_files: 500\n      max_total_bytes: 200000000   # 200MB\n      max_age_days: 14\n\n    - name: telegram_images\n      kind: directory\n      # applied per-workspace root (see integration section)\n      path: \".codex-autorunner/uploads/telegram-images\"\n      glob: \"*\"\n      recursive: false\n      max_files: 500\n      max_total_bytes: 200000000\n      max_age_days: 14\n\n    - name: telegram_voice\n      kind: directory\n      path: \".codex-autorunner/uploads/telegram-voice\"\n      glob: \"*\"\n      recursive: false\n      max_files: 500\n      max_total_bytes: 500000000\n      max_age_days: 14\n\n    - name: update_log\n      kind: file\n      path: \"~/.codex-autorunner/update-standalone.log\"\n      max_bytes: 5000000           # truncate to last 5MB (tail)\n      # optional extension:\n      # max_lines: 20000\n```\n\nConfig parsing changes:\n\n* Extend `src/codex_autorunner/config.py` defaults (`DEFAULT_REPO_CONFIG`, `DEFAULT_HUB_CONFIG`).\n* Add config validation: types, non-negative ints, boolean flags, `kind ∈ {directory,file}`.\n\n---\n\n### 2) Housekeeping engine (`codex_autorunner/housekeeping.py`)\n\nAdd a new module implementing:\n\n**Data model**\n\n* `HousekeepingRule` (name, kind, path, glob, limits, recursive, etc.)\n* `HousekeepingConfig` (enabled, interval, min_file_age_seconds, dry_run, rules)\n\n**Directory cleanup algorithm**\nFor each directory-rule:\n\n1. Resolve rule `path` relative to a provided `root` (repo root / workspace root) unless path is absolute or `~`.\n2. Enumerate matching files (optionally recursive).\n3. Filter out anything newer than `min_file_age_seconds` to avoid deleting active writes.\n4. Apply deletions in this order:\n\n   * **Age**: delete files older than `max_age_days` (if set).\n   * **Count**: if `max_files` exceeded, delete oldest-by-mtime until within limit.\n   * **Size**: if `max_total_bytes` exceeded, delete oldest-by-mtime until within limit.\n5. Optionally remove empty directories created under the target path.\n6. Emit a structured log event with:\n\n   * rule name, scanned_count, deleted_count, deleted_bytes, elapsed_ms, errors\n\n**File cleanup algorithm (single-file rules)**\n\n* If `max_bytes` exceeded: truncate file to keep the tail (avoid reading whole file into memory).\n* (Optional) If `max_lines` supported: tail by lines.\n\nReturn a summary object so callers can display/telemetry totals.\n\n---\n\n### 3) Background scheduling integration\n\n#### Repo server (FastAPI)\n\n* Add a housekeeping startup loop in `src/codex_autorunner/server.py` inside `create_app()` (similar to the existing terminal cleanup task).\n* Implementation pattern:\n\n  * `asyncio.create_task(_housekeeping_loop())`\n  * In the loop, `await asyncio.sleep(interval_seconds)` then `await asyncio.to_thread(run_housekeeping_once, ...)`\n* Run against:\n\n  * repo root (`engine.repo_root`) for repo-local rules (run logs, terminal uploads, github.json if ever added)\n  * also optional absolute rules (update log) if included\n\n#### Hub server (FastAPI hub)\n\n* Add a housekeeping loop in `create_hub_app()` for hub-level artifacts only (update cache/log).\n* Avoid scanning all repo mounts from hub if each repo sub-app already runs housekeeping; keep hub loop focused on `~/.codex-autorunner/*`.\n\n#### Telegram bot\n\n* In `TelegramBotService.run_polling()` add:\n\n  * `self._housekeeping_task = asyncio.create_task(self._housekeeping_loop())`\n* Define `_housekeeping_loop()`:\n\n  * sleeps on `interval_seconds`\n  * runs housekeeping across relevant workspace roots\n* Workspace roots to apply telegram rules to:\n\n  * For media stored under the *workspace path* (`record.workspace_path/.codex-autorunner/uploads/...`):\n\n    * derive candidate workspace roots from the bot’s state store (topics) if available\n    * and/or do a bounded scan under known locations (e.g. hub workspaces + current repo root)\n  * For app-server state roots `~/.codex-autorunner/workspaces/<id>/...` (optional future extension):\n\n    * consider separate rule set (see “Future extensions”)\n\nSafety:\n\n* Ensure telegram housekeeping does not delete files modified in last `min_file_age_seconds`.\n\n---\n\n### 4) CLI helper (optional but useful)\n\nAdd a manual command to run housekeeping once and print results:\n\n* `codex-autorunner housekeeping run [--dry-run]`\n* `codex-autorunner housekeeping status` (optional: shows current disk usage per rule)\n\nThis reduces risk when enabling deletions.\n\n---\n\n## Work plan checklist\n\n### Phase 1: Core implementation\n\n* [ ] Add `housekeeping` defaults to `DEFAULT_REPO_CONFIG` and `DEFAULT_HUB_CONFIG` (`src/codex_autorunner/config.py`)\n* [ ] Add config parsing/validation and expose parsed config on `RepoConfig`/`HubConfig`\n* [ ] Implement `src/codex_autorunner/housekeeping.py`\n\n  * [ ] directory pruning by age/count/total-bytes\n  * [ ] file truncation by max-bytes (tail)\n  * [ ] dry-run support\n  * [ ] structured logging via `logging_utils.log_event`\n* [ ] Integrate repo server background loop (`server.create_app`)\n* [ ] Integrate hub server background loop (`server.create_hub_app`) for home-level artifacts\n* [ ] Integrate telegram bot housekeeping loop (`TelegramBotService.run_polling`)\n\n### Phase 2: Coverage + tightening\n\n* [ ] Add default rules for:\n\n  * [ ] `.codex-autorunner/runs`\n  * [ ] `.codex-autorunner/uploads/terminal-images`\n  * [ ] `.codex-autorunner/uploads/telegram-images`\n  * [ ] `.codex-autorunner/uploads/telegram-voice`\n  * [ ] `~/.codex-autorunner/update-standalone.log`\n* [ ] Add small safety mechanisms:\n\n  * [ ] global “min file age” grace period\n  * [ ] skip non-files/symlinks (don’t follow symlinks)\n  * [ ] handle permission errors without crashing loop\n* [ ] Add documentation in README / sample config explaining each rule and recommended defaults\n\n### Phase 3: Tests\n\n* [ ] Unit tests for pruning logic (new `tests/test_housekeeping.py`)\n\n  * [ ] respects `max_files`\n  * [ ] respects `max_total_bytes`\n  * [ ] respects `max_age_days`\n  * [ ] respects `min_file_age_seconds`\n  * [ ] dry-run does not delete\n  * [ ] file-truncation keeps tail only\n* [ ] Integration-ish tests:\n\n  * [ ] server startup registers housekeeping task without crashing\n\n---\n\n## Acceptance criteria\n\n* With housekeeping enabled and small caps in config:\n\n  * targeted directories converge to at-or-under limits after a run\n  * no process crashes if a directory is missing or permissions block deletion\n* Housekeeping never deletes:\n\n  * `.codex-autorunner/*.md` docs\n  * files modified within the grace period\n* Each housekeeping run emits a log event including deleted count and freed bytes.\n* We will set a resonable default max files and max size, but NOT set a max age by default. That means we WILL NOT automatically delete files by age unless the user modifies the config themselves\n\n---\n\n## Future extensions (optional follow-ups)\n\n* Add support for “workspace state” pruning under `~/.codex-autorunner/workspaces/<id>/`:\n\n  * prune old `codex_home` caches by total bytes or max age\n  * use LRU based on “last_used_at” if we persist it\n* Add an API endpoint to view housekeeping status/usage (per rule) in UI.\n","comments":[{"id":"IC_kwDOQlmRw87dXFuu","author":{"login":"Git-on-my-level"},"authorAssociation":"OWNER","body":"Test comment for github context fixture.","createdAt":"2026-01-06T09:09:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/Git-on-my-level/codex-autorunner/issues/24#issuecomment-3713817518","viewerDidAuthor":true}],"labels":[],"number":24,"state":"OPEN","title":"Static file cleanup and disk space management","url":"https://github.com/Git-on-my-level/codex-autorunner/issues/24"}
